generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  password             String // Hashed password
  name                 String
  jobberAccessToken    String? // Jobber OAuth access token
  jobberRefreshToken   String? // Jobber OAuth refresh token
  jobberTokenExpiresAt DateTime? // Token expiration time
  jobberAccountId      String? // Jobber account ID
  publicFormKey        String?  @unique @map("public_form_key")
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  notificationTemplates NotificationTemplate[]
  stripeCustomerId           String?                     @unique
  stripeSubscriptions        StripeSubscription[]
  teamMembers                TeamMember[]
  kpiEntries                 KpiEntry[]
  teamMemberTypes            TeamMemberType[]
  teamMemberStatuses         TeamMemberStatus[]
  customMetricDefinitions    CustomMetricDefinition[]
  inventoryColumnDefinitions InventoryColumnDefinition[]
  inventory                  Inventory[]
  inventoryCategories        InventoryCategory[]
  inventoryStores            InventoryStore[]
  inventoryPurchases         InventoryPurchase[]
  inventoryNotes             InventoryNote[]
  inventoryFormConfigs       InventoryFormConfig[]
  inventoryFormSubmissions   InventoryFormSubmission[]
  inventorySnapshots          InventorySnapshot[]
  inventoryTechnicians       InventoryTechnician[]
  inventoryTechnicianPurchases InventoryTechnicianPurchase[]

  @@index([email])
  @@index([jobberAccountId])
  @@index([publicFormKey])
  @@map("users")
}

model StripePlan {
  id              String   @id @default(uuid())
  planKey         String   @unique
  name            String
  amount          Int
  currency        String
  interval        String
  stripeProductId String
  stripePriceId   String
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("stripe_plans")
}

model StripeSubscription {
  id                   String    @id @default(uuid())
  userId               String
  planKey              String
  stripeSubscriptionId String    @unique
  status               String
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("stripe_subscriptions")
}

model Client {
  id                           String    @id @default(uuid())
  jId                          String    @unique
  createdDate                  DateTime?
  isCompany                    Boolean   @default(false)
  displayName                  String?
  companyName                  String?
  firstName                    String?
  lastName                     String?
  email                        String?
  emailsJson                   String?
  mainPhone                    String?
  workPhone                    String?
  mobilePhone                  String?
  homePhone                    String?
  faxPhone                     String?
  otherPhone                   String?
  phonesJson                   String?
  tags                         String?
  notesJson                    String?
  noteAttachmentsJson          String?
  billingStreet1               String?
  billingStreet2               String?
  billingCity                  String?
  billingState                 String?
  billingCountry               String?
  billingZip                   String?
  servicePropertyName          String?
  serviceStreet1               String?
  serviceStreet2               String?
  serviceCity                  String?
  serviceState                 String?
  serviceCountry               String?
  serviceZip                   String?
  cftHavePets                  String?
  cftHaveKids                  String?
  cftTrashCanInventory         String?
  cftAreasToAvoid              String?
  cfsChangeSheets              String?
  cftPreferredTimeRecurring    String?
  cfsPreferredTimeContact      String?
  cftTypeOfProperty            String?
  cftAdditionalInfo            String?
  cftResponsibidProfile        String?
  pftAddressAdditionalInfo     String?
  pftApartmentNumber           String?
  pftFootage                   String?
  pftNotes                     String?
  receivesAutoVisitReminders   Boolean   @default(false)
  receivesAutoJobFollowups     Boolean   @default(false)
  receivesAutoQuoteFollowups   Boolean   @default(false)
  receivesAutoInvoiceFollowups Boolean   @default(false)
  archived                     Boolean   @default(false)
  textMessageEnabledPhone      String?
  leadSource                   String?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt

  @@index([email])
  @@index([jId])
  @@map("clients")
}

model Quote {
  id          String  @id @default(uuid())
  jId         String  @unique
  quoteNumber String?

  // Client Info (from quote.client)
  clientJId   String?
  clientName  String?
  clientEmail String?
  clientPhone String?

  // Property Info (from quote.property)
  servicePropertyName String?
  serviceStreet       String?
  serviceCity         String?
  serviceProvince     String?
  serviceZip          String?
  serviceCountry      String?

  // Quote Basic Info
  title       String?
  status      String?
  salesperson String?

  // Amounts (from quote.amounts)
  subtotal         String?
  total            String?
  discount         String?
  collectedDeposit String?
  requiredDeposit  String?

  // Status-Based Dates (conditional based on quoteStatus)
  draftedDate          String?
  sentDate             String?
  changesRequestedDate String?
  approvedDate         String?
  convertedDate        String?
  archivedDate         String?

  // Other Dates
  sentAt            DateTime?
  clientHubViewedAt String?
  createdAt         DateTime?
  updatedAt         DateTime?

  // Line Items (JSON backup + formatted)
  lineItemsJson String?
  lineItems     String?

  // Job Numbers (from quote.jobs)
  jobNumbers String?

  // Custom Fields (Label-based mapping from workflow)
  timeEstimated          String?
  desiredFrequency       String?
  typeOfCleaning         String?
  exactSqFt              String?
  additionalRequest      String?
  zone                   String?
  dirtScale              String?
  birthdayMonth          String?
  referredBy             String?
  typeOfProperty         String?
  parkingDetails         String?
  squareFoot             String?
  frequency              String?
  preferredTimeOfContact String?

  // JSON Backups (Complete data)
  customFieldsJson String?
  clientJson       String?
  propertyJson     String?
  amountsJson      String?

  // Metadata
  leadSource String?
  sentTo     String?
  sentByUser String?

  // Timestamps
  dbCreatedAt DateTime @default(now())
  dbUpdatedAt DateTime @updatedAt

  // Indexes
  @@index([clientJId])
  @@index([quoteNumber])
  @@index([status])
  @@map("quotes")
}

model Tag {
  id                  String   @id @default(uuid())
  jId                 String   @unique
  label               String
  clientJId           String?
  replied             Boolean  @default(false)
  statusForAutomation String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([clientJId])
  @@index([label])
  @@index([replied])
  @@map("tags")
}

model Job {
  id        String  @id @default(uuid())
  jId       String  @unique // Jobber Job ID (EncodedId)
  jobNumber String?
  jobType   String? // "ONE_TIME" or "RECURRING"
  title     String?
  jobStatus String? // draft, scheduled, in_progress, completed, archived, etc.

  // Client Info (from job.client)
  clientJId   String?
  clientName  String?
  clientEmail String?
  clientPhone String?

  // Property Info (from job.property)
  servicePropertyName String?
  serviceStreet       String?
  serviceCity         String?
  serviceProvince     String?
  serviceZip          String?
  serviceCountry      String?

  // Billing Info
  billingType     String?
  billingStreet   String?
  billingCity     String?
  billingProvince String?
  billingZip      String?

  // Dates
  createdAt         DateTime?
  startAt           DateTime?
  endAt             DateTime?
  createdDate       String? // Formatted: yyyy-MM-dd
  scheduleStartDate String? // Formatted: yyyy-MM-dd
  scheduleEndDate   String? // Formatted: yyyy-MM-dd
  closedDate        String? // Formatted: yyyy-MM-dd

  // Recurring-specific fields (nullable - only for RECURRING)
  visitFrequency     String? // visits.totalCount
  billingFrequency   String?
  automaticInvoicing String?
  visitsAssignedTo   String?
  completedVisits    String?
  startTime          String? // HH:MM:SS from last visit
  endTime            String? // HH:MM:SS from last visit

  // Line Items
  lineItemsJson String? // Complete lineItems array as JSON
  lineItems     String? // Formatted string for display

  // Invoices
  numberOfInvoices String? // Comma-separated invoice numbers
  invoicesJson     String? // Complete invoices array as JSON

  // Quote
  quoteNumber String?

  // Salesperson
  salesperson String? // firstName + lastName

  // Instructions
  instructions           String?
  additionalInstructions String?

  // Custom Fields (Label-based mapping - same as Quote workflow)
  typeOfProperty         String?
  frequency              String?
  referredBy             String?
  birthdayMonth          String?
  typeOfCleaning         String?
  hours                  String?
  cleaningInstructions   String?
  howToGetInTheHouse     String?
  detailToGetInTheHouse  String?
  cleanInsideOfTheStove  String?
  cleanInsideOfTheFridge String?
  windowsToBeCleaned     String?
  glassDoorsToBeCleaned  String?
  typerOfProductsToUse   String?
  squareFoot             String?
  exactSqFt              String?
  zone                   String?
  parkingDetails         String?
  responsibidProfile     String?
  preferredTimeOfContact String?
  pets                   String?
  clientsProductsNotes   String?
  trashCanInventory      String?
  changeSheets           String?
  cleaningTech           String?

  // JSON Backups (Complete data)
  customFieldsJson String? // All custom fields as JSON
  clientJson       String? // Complete client object as JSON
  propertyJson     String? // Complete property object as JSON
  visitsJson       String? // Complete visits array as JSON

  // Totals
  total String? // Sum of lineItems.totalPrice

  // Timestamps
  dbCreatedAt DateTime @default(now())
  dbUpdatedAt DateTime @updatedAt

  // Indexes
  @@index([clientJId])
  @@index([jobNumber])
  @@index([jobType])
  @@index([jobStatus])
  @@map("jobs")
}

model TeamMember {
  id                    String   @id @default(uuid())
  photo                 String?
  name                  String
  slackId               String?  @map("slack_id")
  type                  String
  status                String
  employmentType        String   @map("employment_type")
  email                 String
  phone                 String
  address               String
  birthday              String
  primaryLanguage       String   @map("primary_language")
  trainingStartDate     String?  @map("training_start_date")
  trainingEndDate       String?  @map("training_end_date")
  workStartDate         String?  @map("work_start_date")
  lastMinuteCallOffs    Int      @default(0) @map("last_minute_call_offs")
  arrivingLate          Int      @default(0) @map("arriving_late")
  excusedTimeOffs       Int      @default(0) @map("excused_time_offs")
  complaints            Int      @default(0)
  npsMonthly            Int      @default(0) @map("nps_monthly")
  npsAverage            Int      @default(0) @map("nps_average")
  googleReviewsObtained Int      @default(0) @map("google_reviews_obtained")
  starOfMonth           Boolean  @default(false) @map("star_of_month")
  createdById           String   @map("created_by_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  createdBy      User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  kpiEntries     KpiEntry[]
  inventoryNotes InventoryNote[]

  @@index([createdById])
  @@map("team_members")
}

model KpiEntry {
  id           String   @id @default(uuid())
  teamMemberId String   @map("team_member_id")
  kpiType      String   @map("kpi_type")
  date         String
  description  String
  cost         String?
  createdById  String   @map("created_by_id")
  createdAt    DateTime @default(now()) @map("created_at")

  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  createdBy  User       @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([teamMemberId])
  @@map("kpi_entries")
}

model InventoryNote {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  noteText     String   @map("note_text")
  nyTimestamp  String   @map("ny_timestamp")
  noteType     String   @default("general") @map("note_type")
  teamMemberId String?  @map("team_member_id")
  createdAt    DateTime @default(now()) @map("created_at")

  user       User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamMember TeamMember?  @relation(fields: [teamMemberId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([teamMemberId])
  @@map("inventory_notes")
}

model InventoryCategory {
  id              String   @id @default(uuid())
  userId          String?  @map("user_id")
  name            String
  isVisibleOnForm Boolean  @default(true) @map("is_visible_on_form")
  createdAt       DateTime @default(now()) @map("created_at")

  user      User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  inventory Inventory[]

  @@unique([userId, name])
  @@index([userId])
  @@map("inventory_categories")
}

model Inventory {
  id                  String   @id @default(uuid())
  userId              String?  @map("user_id")
  name                String
  type                String
  categoryId          String?  @map("category_id")
  totalRequested      Int      @default(0) @map("total_requested")
  totalInventory      Int      @default(0) @map("total_inventory")
  pricePerUnit        String?  @map("price_per_unit")
  idealTotalInventory Int      @default(0) @map("ideal_total_inventory")
  toBeOrdered         Int      @default(0) @map("to_be_ordered")
  threshold           Int      @default(3)
  rowNumber           Int?     @map("row_number")
  preferredStore      String?  @map("preferred_store")
  dynamicFields       Json?    @map("dynamic_fields")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user      User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  category  InventoryCategory?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  purchases InventoryPurchase[]

  @@index([userId])
  @@index([categoryId])
  @@index([type])
  @@map("inventory")
}

model InventoryTechnician {
  id                 String   @id @default(uuid())
  userId             String?  @map("user_id")
  techName           String   @map("tech_name")
  latestPurchaseDate String?  @map("latest_purchase_date")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user      User?                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchases InventoryTechnicianPurchase[]

  @@unique([userId, techName])
  @@index([userId])
  @@map("inventory_technicians")
}

model InventoryTechnicianPurchase {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  technicianId String   @map("technician_id")
  purchaseDate String   @map("purchase_date")
  itemsRaw     String   @map("items_raw")
  itemsParsed  Json?    @map("items_parsed")
  isCompleted  Boolean  @default(false) @map("is_completed")
  createdAt    DateTime @default(now()) @map("created_at")

  user       User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  technician InventoryTechnician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([technicianId])
  @@map("inventory_technician_purchases")
}

model InventorySnapshot {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  month        Int
  year         Int
  snapshotData Json     @map("snapshot_data")
  createdAt    DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@map("inventory_snapshots")
}

model InventoryStore {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("inventory_stores")
}

model InventoryFormConfig {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id")
  fieldName     String   @map("field_name")
  fieldType     String   @map("field_type")
  categoryName  String   @map("category_name")
  isVisible     Boolean  @default(true) @map("is_visible")
  isRequired    Boolean  @default(false) @map("is_required")
  dropdownMin   Int      @default(1) @map("dropdown_min")
  dropdownMax   Int      @default(5) @map("dropdown_max")
  dropdownMaxW2 Int      @default(5) @map("dropdown_max_w2")
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("inventory_form_config")
}

model InventoryFormSubmission {
  id                    String   @id @default(uuid())
  userId                String?  @map("user_id")
  submitterName         String   @map("submitter_name")
  productSelections     Json     @map("product_selections")
  toolSelections        Json     @map("tool_selections")
  additionalNotes       String?  @map("additional_notes")
  returningEmptyGallons String?  @map("returning_empty_gallons")
  createdAt             DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("inventory_form_submissions")
}

model InventoryColumnDefinition {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  columnKey    String   @map("column_key")
  columnLabel  String   @map("column_label")
  displayOrder Int      @default(0) @map("display_order")
  isVisible    Boolean  @default(true) @map("is_visible")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, columnKey])
  @@index([userId])
  @@map("inventory_column_definitions")
}

model InventoryPurchase {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  orderId     String   @map("order_id")
  itemId      String?  @map("item_id")
  itemName    String   @map("item_name")
  orderedFrom String   @map("ordered_from")
  amount      String
  quantity    Int      @default(1)
  purchasedAt String   @map("purchased_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Inventory?  @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([itemId])
  @@map("inventory_purchases")
}

model CustomMetricDefinition {
  id          String   @id @default(uuid())
  name        String
  description String?
  icon        String?
  color       String?
  fields      Json // Array of { id, name, type, required }
  isActive    Boolean  @default(true) @map("is_active")
  threshold   Int? // Threshold count to trigger alerts
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@map("custom_metric_definitions")
}

model TeamMemberType {
  id          String   @id @default(uuid())
  name        String
  isActive    Boolean  @default(true) @map("is_active")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([name, createdById])
  @@index([createdById])
  @@map("team_member_types")
}

model TeamMemberStatus {
  id          String   @id @default(uuid())
  name        String
  isActive    Boolean  @default(true) @map("is_active")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([name, createdById])
  @@index([createdById])
  @@map("team_member_statuses")
}

model NotificationTemplate {
  id          String   @id @default(uuid())
  createdById String   @map("created_by_id")
  template    String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([createdById])
  @@index([createdById])
  @@map("notification_templates")
}
